<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
  <title>covid-19-map</title>
  <link rel="stylesheet" href="/stylesheets/style.css">
  <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=n9dlshrueb"></script>
  <script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

</head>

<body>
  <div id="navbar">my-covid-map</div>
  <div id="infoBox">
    <div id="infoTitle">현재 날짜</div>
    <div id="infoContent">2020.10.17</div>
  </div>
  <div id="current">현재 위치</div>
  <div id="map" style="width:100%;height:100vh;"></div>

  <script type="text/javascript" src="/data/data.js"></script>
  <script>
    var mapOptions = {
      center: new naver.maps.LatLng(37.3595704, 127.105399),
      zoom: 10
    };

    var map = new naver.maps.Map('map', mapOptions);

    var markerList = [];
    var infowindowList = [];

    //마커(커스터 마이징)
    for (var i in data) {
      var target = data[i];
      var latlng = new naver.maps.LatLng(target.lat, target.lng);

      marker = new naver.maps.Marker({
        map,
        position: latlng,
        icon: {
          content: `<div class="marker"></div>`,
          anchor: new naver.maps.Point(12, 12),
        },
      });

      var content = `
      <div class="infowindow_wrap">
        <div class="infowindow_title">${target.title}</div>
        <div class="infowindow_content">${target.content}</div>
        <div clas="infowindow_date">${target.date}</div>
      </div>`;

      var infowindow = new naver.maps.InfoWindow({
        content,
        backgroundColor:'#00ff0000',
        borderColor:'00ff0000',
        anchorSize:new naver.maps.Size(0,0) //꼬리표 설정
      });

      markerList.push(marker);
      infowindowList.push(infowindow);
    }
    
    function getClickHandler(i){
      return function(){
        var marker = markerList[i];
        var infowindow = infowindowList[i];

        //infowindow 지도 위에 표시되어있는지 true false;
       if(infowindow.getMap()){
         infowindow.close(); // 열려 있을면 닫아줌
       }else{
         infowindow.open(map,marker);//
       }
      }
    }
    //지도눌렀을때 마커가 사라지는 기능
    function ClickMap(i){
      return function(){
       var infowindow = infowindowList[i];
       infowindow.close(); 
      }
    }

    for(var i=0;i<markerList.length;i++){

      naver.maps.Event.addListener(map,"click",ClickMap(i));
      naver.maps.Event.addListener(markerList[i],"click",getClickHandler(i));
    }
    //현재위치를 확대하는
   $('#current').click(()=>{
     if('geolocation' in navigator){
      navigator.geolocation.getCurrentPosition(function(position){
        const lat = position.coords.latitude;
        const lng= position.coords.longitude;
        const latlng = new naver.maps.LatLng(lat,lng);
        //마커 생성
        marker = new naver.maps.Marker({
          map,
          position:latlng,
          icon:{
            content:`<img class="pulse" draggable="false" unselected="on" src="https://myfirstmap.s3.ap-northeast-2.amazonaws.com/circle.png">`,
            anchor:new naver.maps.Point(11,11),


          }
        });
        map.setZoom(14,true);
        map.panTo(latlng);
      });
     }else{
       alert('위치 정보 사용 불가능')
     }
   })

    
    
    // marker = new naver.maps.Marker({
    //   map,
    //   position:new naver.maps.LatLng(37.3595704, 127.105399),
    //   icon:{
    //     content:`<div class="marker"></div>`
    //   }
    // });

  </script>
</body>

</html>